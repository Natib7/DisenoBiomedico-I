#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BMP280.h>
#include <Adafruit_MPU6050.h>

// ====== OBJETOS DE LOS SENSORES ======
Adafruit_BMP280 bmp;       // Bar√≥metro y alt√≠metro
Adafruit_MPU6050 mpu;      // IMU de movimiento (aceler√≥metro + giroscopio)

// ====== PIN DEL MOTOR VIBRADOR ======
const int motorPin = 25;   // Pin digital conectado a IN del m√≥dulo vibrador

// ====== VARIABLES DE REFERENCIA ======
float altitudBase = 0;     // Altitud inicial (referencia)
bool calibrado = false;

void setup() {
  Serial.begin(115200);
  Wire.begin();
  pinMode(motorPin, OUTPUT);
  digitalWrite(motorPin, LOW);

  Serial.println("üîß Iniciando sensores...");

  // --- Inicializar MPU6050 ---
  if (!mpu.begin()) {
    Serial.println("‚ùå No se detecta el sensor MPU6050. Verifica conexiones SDA/SCL.");
    while (1);
  }

  // --- Inicializar BMP280 ---
  if (!bmp.begin(0x76)) {   // Algunas placas usan 0x77
    Serial.println("‚ùå No se detecta el sensor BMP280. Revisa la direcci√≥n I2C.");
    while (1);
  }

  // --- Configurar IMU ---
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);

  // --- Mensaje de √©xito ---
  Serial.println("‚úÖ Tobillera inicializada correctamente.");
  Serial.println("Mant√©n el dispositivo quieto unos segundos para calibrar altitud base...");

  delay(2000);
  altitudBase = bmp.readAltitude(1013.25);
  calibrado = true;
  Serial.print("Altitud base registrada: ");
  Serial.print(altitudBase, 2);
  Serial.println(" m");
}

void loop() {
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  // --- C√°lculo de cadencia simulada (basada en movimiento del eje Y) ---
  float cadencia = abs(a.acceleration.y) * 10; // pasos por minuto aprox
  Serial.print("Cadencia estimada: ");
  Serial.print(cadencia, 1);
  Serial.println(" pasos/min");

  // --- Lectura del bar√≥metro ---
  float presion = bmp.readPressure() / 100.0;          // hPa
  float altitud = bmp.readAltitude(1013.25);           // m
  float deltaAltitud = altitud - altitudBase;          // diferencia respecto al inicio

  Serial.print("Presi√≥n: ");
  Serial.print(presion);
  Serial.print(" hPa | Altitud actual: ");
  Serial.print(altitud, 2);
  Serial.print(" m | Diferencia: ");
  Serial.print(deltaAltitud, 2);
  Serial.println(" m");

  // --- Control del motor vibrador seg√∫n desnivel ---
  if (abs(deltaAltitud) > 2.0) {  // si sube o baja m√°s de 2 m respecto a base
    digitalWrite(motorPin, HIGH);
    Serial.println("‚ö†Ô∏è Desnivel detectado -> Vibraci√≥n activada");
  } else {
    digitalWrite(motorPin, LOW);
  }

  Serial.println("-------------------------------");
  delay(1000);
}

