#include <Wire.h>               // Comunicación I2C
#include "MAX30105.h"           // Librería del sensor MAX30102/MAX30105
#include "heartRate.h"          // Librería auxiliar para cálculo de FC

MAX30105 particleSensor;        // Objeto del sensor óptico
const int lm35Pin = 34;         // Pin analógico donde se conecta el LM35

void setup() {
  Serial.begin(115200);         // Inicializa el monitor serial
  Wire.begin();                 // Inicializa la comunicación I2C

  Serial.println("Iniciando brazalete biomédico...");

  // --- Inicialización del sensor MAX30102 ---
  if (!particleSensor.begin(Wire, I2C_SPEED_STANDARD)) {
    Serial.println("No se detecta el sensor MAX30102. Verifica conexiones SDA/SCL (21/22).");
    while (1);  // Detiene el programa si el sensor no se detecta
  }
  Serial.println("MAX30102 detectado correctamente.");

  // Configuración del MAX30102
  // (se ajusta para lectura de pulso y SpO₂)
  particleSensor.setup();              
  particleSensor.setPulseAmplitudeRed(0x0A);    // LED rojo baja intensidad
  particleSensor.setPulseAmplitudeIR(0x0A);     // LED infrarrojo baja intensidad
  particleSensor.setPulseAmplitudeGreen(0);     // Desactiva el LED verde

  Serial.println("Configuración completada. Iniciando mediciones...\n");
}

void loop() {
  // LECTURA DE FRECUENCIA CARDÍACA (MAX30102) 
  long irValue = particleSensor.getIR();    // Señal IR para detección de pulso

  if (checkForBeat(irValue) == true) {      // Detecta un latido
    static unsigned long lastBeat = 0;      // Guarda el tiempo del último latido
    unsigned long beatTime = millis();      // Tiempo actual
    int beatInterval = beatTime - lastBeat; // Diferencia entre latidos
    lastBeat = beatTime;

    // Calcular frecuencia cardíaca (en bpm)
    float heartRate = 60000.0 / beatInterval;

    Serial.print("Frecuencia cardíaca: ");
    Serial.print(heartRate);
    Serial.println(" bpm");
  }

  // LECTURA DE TEMPERATURA CORPORAL (LM35)
  // LM35 entrega 10 mV por cada grado Celsius
  int rawValue = analogRead(lm35Pin);
  float voltage = (rawValue / 4095.0) * 3.3;  // Convierte lectura ADC a voltaje
  float tempC = voltage * 100.0;              // Convierte voltaje a °C (1V ≈ 100°C)

  Serial.print("Temperatura corporal: ");
  Serial.print(tempC);
  Serial.println(" °C");

  // CONDICIÓN DE ALERTA
  // Si la temperatura supera 38°C o no se detecta pulso IR (sensor desconectado),
  if (tempC > 38.0) {
    Serial.println("Alerta: Temperatura elevada detectada (>38 °C)");
  }

  if (irValue < 50000) {
    Serial.println("Advertencia: dedo no detectado o mala lectura del sensor óptico.");
  }

  Serial.println("--------------------------------------");
  delay(1000);  // Espera 1 segundo antes de la siguiente medición
}
