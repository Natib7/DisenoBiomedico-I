#include <WiFi.h>
#include <esp_now.h>

#include <Wire.h>
#include "MAX30105.h"
#include "heartRate.h"

MAX30105 particleSensor;

// Pin analÃ³gico para el LM35
const int LM35_PIN = 34;

// Variables para HRV (variabilidad)
unsigned long lastBeat = 0;
float beats[10];  // Guarda los Ãºltimos intervalos entre latidos
int beatIndex = 0;

// ====== ESTRUCTURA DE DATOS QUE LLEGA DESDE LA TOBILLERA ======
typedef struct __attribute__((packed)) {
  float cadencia;
  float presion;
  float altitud;
  float deltaAltitud;
} TobilleraData;

volatile TobilleraData ultimoDatoTobillera;
volatile bool nuevoDatoTobillera = false;

// ====== CALLBACK DE RECEPCIÃ“N ESP-NOW ======
void onDataRecv(const esp_now_recv_info_t *info, const uint8_t *data, int len) {
  if (len == sizeof(TobilleraData)) {
    memcpy((void *)&ultimoDatoTobillera, data, sizeof(TobilleraData));
    nuevoDatoTobillera = true;
  }
}

void setup() {
  Serial.begin(115200);
  Wire.begin();

  Serial.println("Iniciando sensores del brazalete...");

  // --- InicializaciÃ³n del MAX30102 ---
  if (!particleSensor.begin(Wire, I2C_SPEED_STANDARD)) {
    Serial.println("âŒ No se detecta el MAX30102. Verifica las conexiones SDA/SCL (21, 22).");
    while (1);
  }

  // ConfiguraciÃ³n bÃ¡sica del sensor
  particleSensor.setup();  // LEDs rojos e IR encendidos
  particleSensor.setPulseAmplitudeRed(0x1F);
  particleSensor.setPulseAmplitudeIR(0x1F);
  particleSensor.setPulseAmplitudeGreen(0);  // Desactiva LED verde

  Serial.println("âœ… MAX30102 iniciado correctamente");
  Serial.println("âœ… LM35 listo en pin A34");
  Serial.println("------------------------------------");

  // ====== INICIALIZAR ESP-NOW COMO RECEPTOR ======
  WiFi.mode(WIFI_STA);  // Modo estaciÃ³n (requerido por ESP-NOW)

  if (esp_now_init() != ESP_OK) {
    Serial.println("âŒ Error iniciando ESP-NOW");
  } else {
    Serial.println("âœ… ESP-NOW iniciado (brazalete receptor)");
    esp_now_register_recv_cb(onDataRecv);
  }
}

void loop() {
  // --- Lectura de valores del MAX30102 ---
  long irValue = particleSensor.getIR();
  long redValue = particleSensor.getRed();

  // --- DetecciÃ³n de picos (latidos) ---
  if (checkForBeat(irValue)) {
    unsigned long currentBeat = millis();
    unsigned long delta = currentBeat - lastBeat;
    lastBeat = currentBeat;

    if (delta > 300 && delta < 2000) { // Ignora valores anÃ³malos
      float bpm = 60.0 / (delta / 1000.0);
      Serial.print("â¤ï¸ Frecuencia cardÃ­aca: ");
      Serial.print(bpm);
      Serial.println(" bpm");

      // Guardar intervalo para HRV
      beats[beatIndex % 10] = delta;
      beatIndex++;
    }
  }

  // --- CÃ¡lculo de HRV (desviaciÃ³n estÃ¡ndar de intervalos) ---
  if (beatIndex >= 10) {
    float mean = 0, sdnn = 0;
    for (int i = 0; i < 10; i++) mean += beats[i];
    mean /= 10;
    for (int i = 0; i < 10; i++) sdnn += pow(beats[i] - mean, 2);
    sdnn = sqrt(sdnn / 10);

    Serial.print("ðŸ’“ HRV (SDNN): ");
    Serial.print(sdnn, 1);
    Serial.println(" ms");
    beatIndex = 0;  // Reinicia cÃ¡lculo cada 10 latidos
  }

  // --- EstimaciÃ³n simple de SpO2 ---
  float ratio = (float)redValue / (float)irValue;
  float spo2 = 110 - 25 * ratio; // FÃ³rmula empÃ­rica simplificada
  if (spo2 > 100) spo2 = 100;
  if (spo2 < 80) spo2 = 80;
  Serial.print("ðŸ©¸ SpOâ‚‚ estimado: ");
  Serial.print(spo2, 1);
  Serial.println(" %");

  // --- Lectura de temperatura (LM35) ---
  int raw = analogRead(LM35_PIN);
  float voltage = (raw / 4095.0) * 3.3;
  float tempC = voltage * 100.0; // 10 mV por grado
  Serial.print("ðŸŒ¡ï¸ Temperatura corporal: ");
  Serial.print(tempC, 1);
  Serial.println(" Â°C");

  // --- Monitoreo de estabilidad ---
  Serial.print("IR: "); Serial.print(irValue);
  Serial.print(" | Red: "); Serial.println(redValue);

  // --- Imprimir datos recibidos de la tobillera si hay nuevos ---
  if (nuevoDatoTobillera) {
    nuevoDatoTobillera = false;  // limpiar bandera

    Serial.println("ðŸ“¡ Datos recibidos desde la tobillera:");
    Serial.print("   Cadencia: ");      Serial.print(ultimoDatoTobillera.cadencia);      Serial.println(" pasos/min");
    Serial.print("   PresiÃ³n: ");       Serial.print(ultimoDatoTobillera.presion);       Serial.println(" hPa");
    Serial.print("   Altitud: ");       Serial.print(ultimoDatoTobillera.altitud, 2);    Serial.println(" m");
    Serial.print("   Î”Altitud: ");      Serial.print(ultimoDatoTobillera.deltaAltitud,2);Serial.println(" m");
  }

  Serial.println("------------------------------------");
  delay(1000);
}
