#include <Wire.h>
#include "MAX30105.h"
#include "spo2_algorithm.h"

MAX30105 particleSensor;

// --- Pines del sistema ---
const int tempPin = 34; // Pin analógico para el LM35

// --- Variables ---
float temperatureC = 0.0;
float irBuffer[100];   // Datos de IR del sensor
float redBuffer[100];  // Datos de LED rojo
int bufferLength = 100;
int32_t spo2;          // Saturación de oxígeno
int8_t validSPO2;
int32_t heartRate;     // Frecuencia cardíaca
int8_t validHeartRate;

void setup() {
  Serial.begin(115200);
  Serial.println("Iniciando brazalete biomédico...");

  // Inicializar comunicación I2C
  Wire.begin();

  // Inicializar MAX30102
  if (!particleSensor.begin(Wire, I2C_SPEED_STANDARD)) {
    Serial.println("No se detecta el sensor MAX30102. Verifique las conexiones.");
    while (1);
  }
  Serial.println("Sensor MAX30102 detectado correctamente.");

  // Configuración básica del MAX30102
  particleSensor.setup(); 
  particleSensor.setPulseAmplitudeRed(0x1F);  // Intensidad LED rojo
  particleSensor.setPulseAmplitudeIR(0x1F);   // Intensidad LED IR
  particleSensor.setSampleRate(100);          // Frecuencia de muestreo
  particleSensor.setLEDMode(2);               // Usa ambos LEDs

  Serial.println("Configuración completada. Iniciando lecturas...\n");
}

void loop() {
  // --- Leer datos del sensor MAX30102 ---
  for (byte i = 0; i < bufferLength; i++) {
    while (particleSensor.available() == false) {
      particleSensor.check();
    }
    redBuffer[i] = particleSensor.getRed();
    irBuffer[i] = particleSensor.getIR();
    particleSensor.nextSample();
  }

  // --- Calcular frecuencia cardíaca y SpO2 ---
  maxim_heart_rate_and_oxygen_saturation(irBuffer, bufferLength, redBuffer,
                                         &spo2, &validSPO2, &heartRate, &validHeartRate);

  // --- Leer temperatura del LM35 ---
  int rawADC = analogRead(tempPin);
  float voltage = (rawADC / 4095.0) * 3.3; // Conversión ADC a voltaje (12 bits)
  temperatureC = voltage * 100.0;          // 10 mV/°C (LM35)

  // --- Mostrar resultados ---
  Serial.println("DATOS DEL BRAZALETE");
  if (validHeartRate && validSPO2) {
    Serial.print("Frecuencia cardíaca: ");
    Serial.print(heartRate);
    Serial.println(" bpm");

    Serial.print("Saturación de oxígeno (SpO₂): ");
    Serial.print(spo2);
    Serial.println(" %");
  } else {
    Serial.println("Señal inestable. Coloque bien el sensor en el dedo.");
  }

  Serial.print("Temperatura corporal: ");
  Serial.print(temperatureC, 1);
  Serial.println(" °C");

  Serial.println("-------------------------------");
  delay(2000);
}
